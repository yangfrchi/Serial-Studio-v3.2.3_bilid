#
# Serial Studio
# https://serial-studio.com/
#
# Copyright (C) 2020â€“2025 Alex Spataru
#
# This file is dual-licensed:
#
# - Under the GNU GPLv3 (or later) for builds that exclude Pro modules.
# - Under the Serial Studio Commercial License for builds that include
#   any Pro functionality.
#
# You must comply with the terms of one of these licenses, depending
# on your use case.
#
# For GPL terms, see <https://www.gnu.org/licenses/gpl-3.0.html>
# For commercial terms, see LICENSE_COMMERCIAL.md in the project root.
#
# SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-SerialStudio-Commercial
#

#-------------------------------------------------------------------------------
# Workflow configuration
#-------------------------------------------------------------------------------

name: Deploy

on:
  push:               # Run on push
    paths-ignore:     # File patterns to ignore
    - '**.md'         # Ignore changes to *.md files

  pull_request:       # Run on pull-request
    paths-ignore:     # File-patterns to ignore
    - '**.md'         # Ignore changes to *.md files
    
  workflow_dispatch:

#-------------------------------------------------------------------------------
# Define application name & version
#-------------------------------------------------------------------------------

env:
  VERSION: "3.2.3"
  QT_VERSION_LINUX: 6.9.3
  QT_VERSION_MACOS: 6.9.3
  QT_VERSION_WINDOWS: 6.9.3
  EXECUTABLE: "Serial-Studio-v3.2.3"
  APPLICATION: "Serial Studio v3.2.3"
  UNIXNAME: "serial-studio-3.2.3"
  QML_DIR: "../../app/qml"
  PUBLISHER: "Alex Spataru"
  INSTALL_QT_MACOS: false
  INSTALL_QT_WINDOWS: false
  INSTALL_QT_LINUX_INTEL: false
  INSTALL_QT_LINUX_ARM64: false
  QTFRAMEWORK_BYPASS_LICENSE_CHECK: "true"
  DESCRIPTION: "Multi-purpose serial data visualization & processing program"

#-------------------------------------------------------------------------------
# Begin workflow jobs definition
#-------------------------------------------------------------------------------

jobs:

#-------------------------------------------------------------------------------
# Windows build (MSVC 2022 x86_64)
#-------------------------------------------------------------------------------

  build-windows:
    runs-on: windows-latest
    name: 'ðŸ§Š Windows'
    steps:
    - run: git config --global core.autocrlf input
    - name: 'ðŸ§° Checkout'
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: 'âš™ï¸ Restore Qt Cache'
      uses: actions/cache/restore@v3
      if: env.INSTALL_QT_WINDOWS == 'false'
      with:
        path: |
          ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
          ${{env.USERPROFILE}}/.qt-license
        key: qt-${{runner.os}}-${{env.QT_VERSION_WINDOWS}}-x64-msvc2022_64

    - name: 'âš™ï¸ Install Qt'
      shell: pwsh
      if: env.INSTALL_QT_WINDOWS == 'true'
      env:
        QT_VERSION: ${{env.QT_VERSION_WINDOWS}}
        QT_ARCH: x64
        QT_USERNAME: ${{secrets.QT_USERNAME}}
        QT_PASSWORD: ${{secrets.QT_PASSWORD}}
        QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
      run: |
        ./scripts/install-qt.ps1

    - name: 'âš™ï¸ Save Qt Cache'
      if: env.INSTALL_QT_WINDOWS == 'true'
      uses: actions/cache/save@v3
      with:
        path: |
          ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
          ${{env.USERPROFILE}}/.qt-license
        key: qt-${{runner.os}}-${{env.QT_VERSION_WINDOWS}}-x64-msvc2022_64

    - name: 'âš™ï¸ Add Qt to PATH'
      shell: pwsh
      env:
        QT_VERSION: ${{env.QT_VERSION_WINDOWS}}
        QT_OUTPUT_DIR: ${{github.workspace}}/Qt-${{env.QT_VERSION_WINDOWS}}-${{runner.os}}-x64
      run: |
        $QT_BIN_PATH = "$env:QT_OUTPUT_DIR\$env:QT_VERSION\msvc2022_64\bin"
        $QT_LIBEXEC_PATH = "$env:QT_OUTPUT_DIR\$env:QT_VERSION\msvc2022_64\libexec"
        $CMAKE_PREFIX_PATH = "$env:QT_OUTPUT_DIR\$env:QT_VERSION\msvc2022_64\lib\cmake"

        Write-Output "$QT_BIN_PATH" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        Write-Output "$QT_LIBEXEC_PATH" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        Write-Output "CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH" >> $env:GITHUB_ENV

    - name: 'âš™ï¸ Install CMake'
      uses: lukka/get-cmake@latest
      with:
        useLocalCache: true

    - name: 'ðŸ›  Setup MSVC Development Environment'
      uses: TheMrMilchmann/setup-msvc-dev@v3
      with:
        arch: x64

    - name: 'ðŸš§ Configure with CMake'
      env:
        ARCGIS_API_KEY: ${{secrets.ARCGIS_API_KEY}}
        SERIAL_STUDIO_LICENSE_KEY: ${{secrets.SERIAL_STUDIO_LICENSE_KEY}}
        SERIAL_STUDIO_INSTANCE_ID: ${{secrets.SERIAL_STUDIO_INSTANCE_ID}}
      run: |
        mkdir build
        cd build
        cmake ../ `
          -DCMAKE_CXX_COMPILER=cl `
          -DCMAKE_C_COMPILER=cl `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows-static `
          -DPRODUCTION_OPTIMIZATION=ON `
          -DENABLE_HARDENING=ON `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_COMMERCIAL=OFF `
          -DBUILD_GPL3=ON

    - name: 'ðŸš§ Build application'
      run: |
        cd build
        cmake --build . --config Release -j 16

    - name: 'âš™ï¸ Add msbuild to PATH'
      uses: microsoft/setup-msbuild@v2

    - name: 'âš™ï¸ Install WiX'
      run: dotnet tool install --global wix

    - name: 'ðŸ“¦ Create MSI installer'
      run: |
        cd build
        cpack --verbose
        mv *.msi ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.msi
        mv ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.msi ../

    - name: 'ðŸ“¦ Create portable TGZ'
      run: |
        cd build
        cpack -G TGZ
        mv *.tar.gz ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.tgz

    - name: 'ðŸ“¦ Extract TGZ contents'
      shell: bash
      run: |
        cd build
        7z x ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.tgz
        7z x ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.tar
        DIRNAME=$(tar -tf ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.tar 2>/dev/null | head -1 | cut -f1 -d"/" || true)
        echo $DIRNAME > dirname.txt
        cp ../app/deploy/windows/license.rtf ./License.rtf

    - name: 'ðŸ“ Create Windows batch launcher'
      shell: bash
      run: |
        cd build
        DIRNAME=$(cat dirname.txt)
        echo "@echo off" > "${{env.APPLICATION}}.bat"
        echo "start \"\" \"%~dp0${DIRNAME}\\bin\\${{env.EXECUTABLE}}.exe\"" >> "${{env.APPLICATION}}.bat"

    - name: 'ðŸ“¦ Add files to ZIP'
      shell: bash
      run: |
        cd build
        DIRNAME=$(cat dirname.txt)
        7z a ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows-Portable.zip "${{env.APPLICATION}}.bat" License.rtf $DIRNAME/*
        mv ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows-Portable.zip ..

    - name: 'ðŸ“¤ Upload artifact: MSI installer'
      uses: actions/upload-artifact@v4
      with:
        name: ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.msi
        path: ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows.msi

    - name: 'ðŸ“¤ Upload artifact: Portable ZIP'
      uses: actions/upload-artifact@v4
      with:
       name: ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows-Portable
       path: ${{env.EXECUTABLE}}-${{env.VERSION}}-Windows-Portable.zip

#-------------------------------------------------------------------------------
# Create release
#-------------------------------------------------------------------------------
  upload:
    name: 'ðŸ—‚ Create release and upload artifacts'
    needs:
      - build-windows

    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && github.ref_name || 'continuous' }}

    steps:
      - name: 'ðŸ“¥ Download artifacts'
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: 'ðŸ—‘ï¸ Delete previous release and tag if exists'
        run: |
          if gh release view "$RELEASE_TAG" --repo "$GITHUB_REPOSITORY" &>/dev/null; then
            echo "Release '$RELEASE_TAG' exists. Deleting..."
            gh release delete "$RELEASE_TAG" --cleanup-tag --yes --repo "$GITHUB_REPOSITORY" || echo "Failed to delete release. Ignoring."
          else
            echo "No release named '$RELEASE_TAG' found. Skipping delete."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'ðŸš€ Create Release'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.RELEASE_TAG }}
          prerelease: true
          allowUpdates: true
          replacesArtifacts: true
          name: 'Continuous Build'
          artifacts: |
            artifacts/*.msi
            artifacts/*.zip
